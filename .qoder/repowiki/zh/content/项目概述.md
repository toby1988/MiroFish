# 项目概述

<cite>
**本文引用的文件**
- [README.md](file://README.md)
- [README-EN.md](file://README-EN.md)
- [pyproject.toml](file://backend/pyproject.toml)
- [package.json](file://frontend/package.json)
- [run.py](file://backend/run.py)
- [__init__.py](file://backend/app/__init__.py)
- [config.py](file://backend/app/config.py)
- [graph.py](file://backend/app/api/graph.py)
- [simulation.py](file://backend/app/api/simulation.py)
- [simulation_manager.py](file://backend/app/services/simulation_manager.py)
- [logger.py](file://backend/app/utils/logger.py)
- [project.py](file://backend/app/models/project.py)
- [task.py](file://backend/app/models/task.py)
- [App.vue](file://frontend/src/App.vue)
- [main.js](file://frontend/src/main.js)
- [index.js](file://frontend/src/router/index.js)
- [pendingUpload.js](file://frontend/src/store/pendingUpload.js)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 引言
MiroFish 是一款基于多智能体技术的新一代 AI 预测引擎。它通过提取现实世界的种子信息（如突发新闻、政策草案、金融信号），自动构建高保真的平行数字世界；在该世界中，成千上万个具备独立人格、长期记忆与行为逻辑的智能体进行自由交互与社会演化。用户可通过“上帝视角”动态注入变量，精准推演未来走向——“让未来在数字沙盘中预演，助决策在百战模拟后胜出”。

项目愿景涵盖宏观与微观两个层面：
- 宏观：为决策者提供零风险的政策与公关试错实验室；
- 微观：为个人用户提供创意沙盘，无论是推演小说结局还是探索脑洞，皆可有趣、好玩、触手可及。

工作流程分为五个阶段：
1) 图谱构建：种子提取、个体/集体记忆注入、GraphRAG 构建
2) 环境搭建：实体关系抽取、人设生成、Agent 配置注入
3) 开始模拟：双平台并行模拟、自动解析预测需求、动态更新时序记忆
4) 报告生成：ReportAgent 携带丰富工具集与模拟后环境深度交互
5) 深度互动：与模拟世界中的任意一位进行对话，与 ReportAgent 进行对话

**章节来源**
- [README.md](file://README.md#L26-L88)
- [README-EN.md](file://README-EN.md#L26-L88)

## 项目结构
MiroFish 采用前后端分离架构：
- 后端（Python/Flask）：提供图谱构建、模拟准备与运行、报告生成等核心能力，统一管理项目上下文与任务状态
- 前端（Vue3/Vite）：提供可视化流程引导与交互面板，串联“图谱构建—环境搭建—模拟运行—报告生成—深度互动”的全流程体验

```mermaid
graph TB
subgraph "前端"
FE_App["App.vue"]
FE_Router["路由: index.js"]
FE_Main["入口: main.js"]
FE_Store["状态: pendingUpload.js"]
end
subgraph "后端"
BE_Run["启动: run.py"]
BE_Factory["应用工厂: __init__.py"]
BE_Config["配置: config.py"]
BE_Logger["日志: logger.py"]
BE_API_Graph["图谱API: graph.py"]
BE_API_Sim["模拟API: simulation.py"]
BE_Svc_SimMgr["模拟管理: simulation_manager.py"]
BE_Model_Proj["项目模型: project.py"]
BE_Model_Task["任务模型: task.py"]
end
FE_Main --> FE_Router
FE_Router --> FE_App
FE_App --> |"HTTP"| BE_Factory
BE_Factory --> BE_Config
BE_Factory --> BE_API_Graph
BE_Factory --> BE_API_Sim
BE_API_Graph --> BE_Model_Proj
BE_API_Graph --> BE_Model_Task
BE_API_Sim --> BE_Svc_SimMgr
BE_Svc_SimMgr --> BE_Model_Proj
BE_Svc_SimMgr --> BE_Model_Task
BE_Factory --> BE_Logger
BE_Run --> BE_Factory
```

**图表来源**
- [run.py](file://backend/run.py#L25-L46)
- [__init__.py](file://backend/app/__init__.py#L19-L79)
- [config.py](file://backend/app/config.py#L20-L76)
- [graph.py](file://backend/app/api/graph.py#L35-L117)
- [simulation.py](file://backend/app/api/simulation.py#L164-L237)
- [simulation_manager.py](file://backend/app/services/simulation_manager.py#L114-L228)
- [project.py](file://backend/app/models/project.py#L101-L166)
- [task.py](file://backend/app/models/task.py#L54-L99)
- [logger.py](file://backend/app/utils/logger.py#L30-L88)
- [App.vue](file://frontend/src/App.vue#L1-L48)
- [main.js](file://frontend/src/main.js#L1-L10)
- [index.js](file://frontend/src/router/index.js#L1-L53)
- [pendingUpload.js](file://frontend/src/store/pendingUpload.js#L1-L34)

**章节来源**
- [README.md](file://README.md#L81-L88)
- [README-EN.md](file://README-EN.md#L81-L88)
- [pyproject.toml](file://backend/pyproject.toml#L1-L56)
- [package.json](file://frontend/package.json#L1-L22)

## 核心组件
- 项目上下文管理（ProjectManager）
  - 负责项目生命周期的状态持久化与检索，支持文件上传、本体生成、图谱构建、模拟准备与运行等阶段的数据保存
- 任务状态管理（TaskManager）
  - 提供线程安全的任务状态跟踪，支持进度上报、详细进度、结果与错误记录
- 图谱构建与查询（Graph API）
  - 提供本体生成、图谱构建、任务查询、图谱数据获取与删除等接口
- 模拟管理（SimulationManager）
  - 负责从图谱读取实体、生成 Agent Profile、LLM 智能生成模拟配置、准备脚本与运行说明
- 模拟运行（Simulation API）
  - 提供实体读取、模拟创建、准备与状态查询、运行说明等接口
- 日志系统（Logger）
  - 统一日志配置，同时输出到控制台与文件，支持 UTF-8 编码与轮转
- 前端路由与状态
  - Vue3 路由组织流程视图，pendingUpload 用于跨页面传递上传与需求数据

**章节来源**
- [project.py](file://backend/app/models/project.py#L101-L306)
- [task.py](file://backend/app/models/task.py#L54-L185)
- [graph.py](file://backend/app/api/graph.py#L119-L255)
- [simulation_manager.py](file://backend/app/services/simulation_manager.py#L114-L529)
- [simulation.py](file://backend/app/api/simulation.py#L164-L781)
- [logger.py](file://backend/app/utils/logger.py#L30-L127)
- [index.js](file://frontend/src/router/index.js#L1-L53)
- [pendingUpload.js](file://frontend/src/store/pendingUpload.js#L1-L34)

## 架构总览
MiroFish 的整体架构围绕“项目上下文 + 任务状态 + API 层 + 服务层 + 外部集成”的设计展开。后端通过 Flask 应用工厂集中注册蓝图与中间件，统一处理请求日志、CORS 与健康检查；前端通过 Vue Router 组织流程视图，配合后端 API 实现端到端的预测工作流。

```mermaid
graph TB
Client["浏览器/客户端"] --> FE["前端 Vue 应用"]
FE --> API["后端 Flask API"]
API --> Proj["项目模型 ProjectManager"]
API --> Task["任务模型 TaskManager"]
API --> SvcSim["模拟管理 SimulationManager"]
SvcSim --> Zep["Zep 图谱服务"]
SvcSim --> LLM["LLM API"]
SvcSim --> Scripts["预设脚本 (scripts/)"]
API --> Logger["日志系统 Logger"]
API --> Health["健康检查 /health"]
```

**图表来源**
- [__init__.py](file://backend/app/__init__.py#L52-L74)
- [simulation_manager.py](file://backend/app/services/simulation_manager.py#L229-L457)
- [graph.py](file://backend/app/api/graph.py#L259-L525)
- [simulation.py](file://backend/app/api/simulation.py#L358-L781)
- [logger.py](file://backend/app/utils/logger.py#L30-L88)

**章节来源**
- [__init__.py](file://backend/app/__init__.py#L19-L79)
- [config.py](file://backend/app/config.py#L20-L76)

## 详细组件分析

### 图谱构建流程（API 与服务）
图谱构建分为“本体生成”和“图谱构建”两大阶段，均通过异步任务与进度回调实现可观测性与可恢复性。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant API as "Graph API"
participant Proj as "ProjectManager"
participant Task as "TaskManager"
participant Builder as "GraphBuilderService"
participant Zep as "Zep 图谱服务"
Client->>API : POST /api/graph/ontology/generate
API->>Proj : 创建项目/保存文件/提取文本
API->>API : 调用 LLM 生成本体
API-->>Client : 返回 project_id 与本体
Client->>API : POST /api/graph/build
API->>Task : 创建任务
API->>Proj : 读取项目与本体
API->>Builder : 初始化服务
API->>Builder : 分块文本/创建图谱/设置本体
Builder->>Zep : 批量添加文本/等待处理
Builder-->>API : 返回图谱数据
API->>Proj : 更新项目状态
API-->>Client : 返回任务与进度
```

**图表来源**
- [graph.py](file://backend/app/api/graph.py#L119-L255)
- [graph.py](file://backend/app/api/graph.py#L259-L525)
- [project.py](file://backend/app/models/project.py#L101-L166)
- [task.py](file://backend/app/models/task.py#L73-L99)

**章节来源**
- [graph.py](file://backend/app/api/graph.py#L119-L525)
- [project.py](file://backend/app/models/project.py#L101-L306)
- [task.py](file://backend/app/models/task.py#L54-L185)

### 模拟准备与运行（双平台并行）
模拟准备通过“实体读取—Agent Profile 生成—LLM 智能配置—脚本准备”的流水线完成，支持 Twitter 与 Reddit 平台并行运行。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant API as "Simulation API"
participant SimMgr as "SimulationManager"
participant Reader as "ZepEntityReader"
participant ProfGen as "OasisProfileGenerator"
participant CfgGen as "SimulationConfigGenerator"
participant Scripts as "预设脚本"
participant Runner as "SimulationRunner"
Client->>API : POST /api/simulation/create
API-->>Client : 返回 simulation_id
Client->>API : POST /api/simulation/prepare
API->>SimMgr : prepare_simulation(...)
SimMgr->>Reader : filter_defined_entities(graph_id)
SimMgr->>ProfGen : generate_profiles_from_entities(...)
SimMgr->>CfgGen : generate_config(...)
SimMgr->>Scripts : 准备脚本与配置
SimMgr-->>API : 状态更新为 ready
API-->>Client : 返回任务与进度
Client->>API : GET /api/simulation/{id}
API-->>Client : 返回运行说明与指令
Client->>Runner : 执行脚本并行/单平台
```

**图表来源**
- [simulation.py](file://backend/app/api/simulation.py#L164-L237)
- [simulation.py](file://backend/app/api/simulation.py#L358-L781)
- [simulation_manager.py](file://backend/app/services/simulation_manager.py#L229-L457)
- [simulation_manager.py](file://backend/app/services/simulation_manager.py#L506-L529)

**章节来源**
- [simulation.py](file://backend/app/api/simulation.py#L164-L781)
- [simulation_manager.py](file://backend/app/services/simulation_manager.py#L114-L529)

### 数据模型与状态流转（项目与任务）
项目与任务模型负责在服务端持久化状态，避免前端在接口间传递大量数据，提升一致性与可维护性。

```mermaid
classDiagram
class Project {
+string project_id
+string name
+ProjectStatus status
+datetime created_at
+datetime updated_at
+Files[] files
+int total_text_length
+Dict ontology
+string analysis_summary
+string graph_id
+string graph_build_task_id
+string simulation_requirement
+int chunk_size
+int chunk_overlap
+string error
+to_dict() Dict
}
class Task {
+string task_id
+string task_type
+TaskStatus status
+datetime created_at
+datetime updated_at
+int progress
+string message
+Dict result
+string error
+Dict metadata
+Dict progress_detail
+to_dict() Dict
}
class ProjectManager {
+create_project(name) Project
+save_project(project) void
+get_project(id) Project
+list_projects(limit) Project[]
+delete_project(id) bool
+save_file_to_project(pid, file, name) Dict
+save_extracted_text(pid, text) void
+get_extracted_text(pid) string
+get_project_files(pid) string[]
}
class TaskManager {
+create_task(type, metadata) string
+get_task(id) Task
+update_task(id, ...) void
+complete_task(id, result) void
+fail_task(id, error) void
+list_tasks(type) Task[]
+cleanup_old_tasks(max_age) void
}
ProjectManager --> Project : "创建/保存/读取"
TaskManager --> Task : "创建/更新/完成/失败"
```

**图表来源**
- [project.py](file://backend/app/models/project.py#L26-L98)
- [project.py](file://backend/app/models/project.py#L101-L306)
- [task.py](file://backend/app/models/task.py#L22-L52)
- [task.py](file://backend/app/models/task.py#L54-L185)

**章节来源**
- [project.py](file://backend/app/models/project.py#L1-L306)
- [task.py](file://backend/app/models/task.py#L1-L185)

### 前端流程与路由
前端采用 Vue3 + Vue Router，通过路由组织“首页—流程—模拟—报告—互动”五大视图，并通过全局状态暂存上传文件与需求，实现跨页面数据传递。

```mermaid
flowchart TD
Home["首页"] --> Pending["pendingUpload 保存数据"]
Pending --> Process["流程视图 MainView<br/>Step1-Step5"]
Process --> Simulation["模拟视图 SimulationView"]
Simulation --> Run["运行视图 SimulationRunView"]
Run --> Report["报告视图 ReportView"]
Report --> Interaction["互动视图 InteractionView"]
```

**图表来源**
- [index.js](file://frontend/src/router/index.js#L9-L45)
- [pendingUpload.js](file://frontend/src/store/pendingUpload.js#L1-L34)

**章节来源**
- [App.vue](file://frontend/src/App.vue#L1-L48)
- [main.js](file://frontend/src/main.js#L1-L10)
- [index.js](file://frontend/src/router/index.js#L1-L53)
- [pendingUpload.js](file://frontend/src/store/pendingUpload.js#L1-L34)

## 依赖分析
后端依赖以 Flask 为核心，结合 CORS、OpenAI SDK、Zep Cloud、OASIS 仿真引擎与文件处理工具库；前端依赖 Vue3、Vue Router、Axios 与可视化库 D3。

```mermaid
graph LR
Flask["Flask"] --> CORS["Flask-CORS"]
Flask --> OpenAI["openai"]
Flask --> Zep["zep-cloud"]
Flask --> OASIS["camel-oasis / camel-ai"]
Flask --> PyMuPDF["PyMuPDF"]
Flask --> Tools["python-dotenv / pydantic"]
Vue["Vue3"] --> Router["Vue Router"]
Vue --> Axios["Axios"]
Vue --> D3["D3"]
```

**图表来源**
- [pyproject.toml](file://backend/pyproject.toml#L11-L35)
- [package.json](file://frontend/package.json#L11-L21)

**章节来源**
- [pyproject.toml](file://backend/pyproject.toml#L1-L56)
- [package.json](file://frontend/package.json#L1-L22)

## 性能考虑
- 异步任务与进度回调：图谱构建与模拟准备均采用后台线程与任务管理器，避免阻塞主线程，提升用户体验
- 文本分块与批处理：图谱构建阶段对长文本进行分块与批量写入，降低单次请求压力
- 日志轮转与编码：统一日志输出与轮转策略，减少磁盘占用并保证中文显示
- 前后端分离：前端路由与状态管理降低后端负担，便于横向扩展

[本节为通用指导，不直接分析具体文件]

## 故障排查指南
- 配置校验
  - 后端启动前会校验 LLM 与 Zep 的 API Key，若缺失将直接退出并提示检查 .env
- 健康检查
  - 后端提供 /health 接口，可用于容器编排与运维监控
- 日志定位
  - 日志同时输出到控制台与按日轮转的文件，建议优先查看后端日志目录中的最新日志文件
- 常见问题
  - 图谱构建失败：检查 ZEP_API_KEY、网络连通性与文本分块参数
  - 模拟准备失败：确认项目已生成本体、图谱已构建完成，检查 LLM 配置与实体过滤条件
  - 前端无法访问：确认前端与后端端口映射（3000/5001），并检查 CORS 配置

**章节来源**
- [run.py](file://backend/run.py#L25-L46)
- [config.py](file://backend/app/config.py#L66-L76)
- [__init__.py](file://backend/app/__init__.py#L72-L74)
- [logger.py](file://backend/app/utils/logger.py#L30-L88)

## 结论
MiroFish 通过“多智能体 + 平行数字世界”的设计，将复杂预测转化为可交互、可复现、可迭代的仿真过程。其前后端解耦、任务驱动与状态持久化的架构，既满足初学者的易用性需求，也为经验丰富的开发者提供了清晰的扩展路径。依托 OASIS 仿真引擎与 LLM 的智能配置能力，MiroFish 能够在宏观政策与微观创意场景中实现“所想即所见”的预测体验。

[本节为总结性内容，不直接分析具体文件]

## 附录
- 快速开始
  - 源码部署与 Docker 部署两种方式，分别适用于开发与生产环境
  - 前置工具与版本要求明确，建议优先使用 uv 管理 Python 依赖
- 示例与演示
  - 提供武汉大学舆情推演与《红楼梦》结局预测的演示视频，便于理解应用场景与效果
- 致谢
  - 感谢 CAMEL-AI 团队提供的 OASIS 仿真引擎开源贡献

**章节来源**
- [README.md](file://README.md#L89-L173)
- [README-EN.md](file://README-EN.md#L89-L173)
- [README.md](file://README.md#L184-L189)
- [README-EN.md](file://README-EN.md#L184-L189)