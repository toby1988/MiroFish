# 任务监控接口

<cite>
**本文档引用的文件**
- [backend/app/models/task.py](file://backend/app/models/task.py)
- [backend/app/api/graph.py](file://backend/app/api/graph.py)
- [backend/app/models/project.py](file://backend/app/models/project.py)
- [backend/app/utils/retry.py](file://backend/app/utils/retry.py)
- [backend/app/config.py](file://backend/app/config.py)
- [frontend/src/views/Process.vue](file://frontend/src/views/Process.vue)
- [frontend/src/api/index.js](file://frontend/src/api/index.js)
- [frontend/src/api/graph.js](file://frontend/src/api/graph.js)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

MiroFish项目提供了完整的任务监控接口，用于跟踪长时间运行的任务状态。该系统基于Flask框架构建，采用内存中的任务管理器来跟踪任务状态，并通过RESTful API提供任务查询功能。

系统支持两种主要任务监控接口：
- 单个任务查询接口：GET /api/graph/task/{task_id}
- 任务列表查询接口：GET /api/graph/tasks

## 项目结构

```mermaid
graph TB
subgraph "前端层"
FE1[Process.vue<br/>任务监控视图]
FE2[graph.js<br/>API客户端]
FE3[index.js<br/>Axios配置]
end
subgraph "后端层"
BE1[graph.py<br/>Flask蓝图]
BE2[task.py<br/>任务模型]
BE3[project.py<br/>项目模型]
BE4[retry.py<br/>重试机制]
BE5[config.py<br/>配置管理]
end
subgraph "数据库层"
DB1[内存存储<br/>TaskManager]
DB2[文件系统<br/>ProjectManager]
end
FE1 --> FE2
FE2 --> FE3
FE3 --> BE1
BE1 --> BE2
BE1 --> BE3
BE2 --> DB1
BE3 --> DB2
BE4 --> BE1
BE5 --> BE1
```

**图表来源**
- [backend/app/api/graph.py](file://backend/app/api/graph.py#L1-L618)
- [backend/app/models/task.py](file://backend/app/models/task.py#L1-L185)
- [backend/app/models/project.py](file://backend/app/models/project.py#L1-L306)

## 核心组件

### 任务状态管理

系统定义了完整的任务状态枚举，支持四种状态：

```mermaid
stateDiagram-v2
[*] --> PENDING
PENDING --> PROCESSING : 开始执行
PROCESSING --> COMPLETED : 成功完成
PROCESSING --> FAILED : 执行失败
COMPLETED --> [*]
FAILED --> [*]
```

**图表来源**
- [backend/app/models/task.py](file://backend/app/models/task.py#L14-L20)

### 任务数据模型

任务对象包含以下关键字段：
- `task_id`: 唯一任务标识符（UUID生成）
- `task_type`: 任务类型描述
- `status`: 当前任务状态
- `progress`: 进度百分比（0-100）
- `message`: 状态消息
- `result`: 任务执行结果
- `error`: 错误信息
- `metadata`: 额外元数据
- `progress_detail`: 详细进度信息

**章节来源**
- [backend/app/models/task.py](file://backend/app/models/task.py#L22-L51)

### 任务管理器

任务管理器提供线程安全的任务操作接口：

```mermaid
classDiagram
class TaskManager {
-Dict~str, Task~ _tasks
-Lock _task_lock
+create_task(task_type, metadata) str
+get_task(task_id) Task
+update_task(task_id, status, progress, message, result, error, progress_detail)
+complete_task(task_id, result)
+fail_task(task_id, error)
+list_tasks(task_type) list
+cleanup_old_tasks(max_age_hours)
}
class Task {
+str task_id
+str task_type
+TaskStatus status
+datetime created_at
+datetime updated_at
+int progress
+str message
+Dict result
+str error
+Dict metadata
+Dict progress_detail
+to_dict() Dict
}
TaskManager --> Task : manages
```

**图表来源**
- [backend/app/models/task.py](file://backend/app/models/task.py#L54-L184)

**章节来源**
- [backend/app/models/task.py](file://backend/app/models/task.py#L54-L184)

## 架构概览

```mermaid
sequenceDiagram
participant Client as 客户端
participant API as Flask API
participant TM as TaskManager
participant PM as ProjectManager
participant Zep as Zep服务
Client->>API : POST /api/graph/build
API->>PM : 创建项目
API->>TM : create_task()
TM-->>API : 返回task_id
API->>API : 启动后台线程
API->>Zep : 构建图谱
Zep-->>API : 进度更新
API->>TM : update_task()
API-->>Client : 返回task_id
Client->>API : GET /api/graph/task/{task_id}
API->>TM : get_task()
TM-->>API : 返回任务状态
API-->>Client : 任务详情
Client->>API : GET /api/graph/tasks
API->>TM : list_tasks()
TM-->>API : 返回任务列表
API-->>Client : 任务列表
```

**图表来源**
- [backend/app/api/graph.py](file://backend/app/api/graph.py#L259-L525)
- [backend/app/models/task.py](file://backend/app/models/task.py#L73-L104)

## 详细组件分析

### 任务监控API接口

#### 单个任务查询接口

**接口定义**
- 方法：GET
- 路径：/api/graph/task/{task_id}
- 功能：查询指定任务的详细状态

**请求参数**
- `task_id` (路径参数): 任务唯一标识符

**响应格式**
```json
{
  "success": true,
  "data": {
    "task_id": "string",
    "task_type": "string",
    "status": "pending|processing|completed|failed",
    "created_at": "datetime",
    "updated_at": "datetime",
    "progress": 0-100,
    "message": "string",
    "progress_detail": {},
    "result": {},
    "error": "string",
    "metadata": {}
  }
}
```

**状态码**
- 200: 成功获取任务状态
- 404: 任务不存在

**章节来源**
- [backend/app/api/graph.py](file://backend/app/api/graph.py#L529-L545)

#### 任务列表查询接口

**接口定义**
- 方法：GET
- 路径：/api/graph/tasks
- 功能：列出所有任务

**请求参数**
- 无

**响应格式**
```json
{
  "success": true,
  "data": [
    {
      "task_id": "string",
      "task_type": "string",
      "status": "pending|processing|completed|failed",
      "created_at": "datetime",
      "updated_at": "datetime",
      "progress": 0-100,
      "message": "string",
      "progress_detail": {},
      "result": {},
      "error": "string",
      "metadata": {}
    }
  ],
  "count": 0
}
```

**状态码**
- 200: 成功获取任务列表

**章节来源**
- [backend/app/api/graph.py](file://backend/app/api/graph.py#L548-L559)

### 任务生命周期管理

```mermaid
flowchart TD
Start([任务创建]) --> Pending["状态: pending<br/>进度: 0%<br/>消息: 初始化"]
Pending --> Processing["状态: processing<br/>进度: 0-100%<br/>消息: 执行中..."]
Processing --> Completed{"执行成功?"}
Completed --> |是| CompleteTask["状态: completed<br/>进度: 100%<br/>消息: 任务完成"]
Completed --> |否| FailTask["状态: failed<br/>进度: 当前值<br/>消息: 错误信息<br/>错误详情"]
CompleteTask --> Cleanup["自动清理<br/>24小时后移除"]
FailTask --> Cleanup
Cleanup --> End([任务结束])
```

**图表来源**
- [backend/app/models/task.py](file://backend/app/models/task.py#L145-L162)

### 任务ID生成规则

任务ID采用UUID v4生成算法，确保全局唯一性：
- 基于随机数生成
- 128位长度
- 32个十六进制字符
- 包含连字符分隔符

**章节来源**
- [backend/app/models/task.py](file://backend/app/models/task.py#L84)

### 任务状态更新机制

系统支持多种状态更新方式：

1. **进度更新**：通过`update_task()`方法更新进度百分比
2. **状态变更**：通过`complete_task()`和`fail_task()`方法标记最终状态
3. **消息更新**：实时更新任务执行过程中的状态消息
4. **结果记录**：成功完成后记录执行结果

**章节来源**
- [backend/app/models/task.py](file://backend/app/models/task.py#L106-L162)

### 任务清理机制

系统提供自动清理功能，防止内存泄漏：

```mermaid
flowchart TD
CheckTime["检查当前时间"] --> CalcCutOff["计算截止时间<br/>当前时间 - 24小时"]
CalcCutOff --> ScanTasks["扫描任务列表"]
ScanTasks --> CheckAge{"任务创建时间<br/>是否早于截止时间"}
CheckAge --> |否| Skip["跳过清理"]
CheckAge --> |是| CheckStatus{"状态是否为<br/>completed或failed"}
CheckStatus --> |否| Skip
CheckStatus --> |是| Remove["从内存中移除任务"]
Remove --> NextTask["检查下一个任务"]
Skip --> NextTask
NextTask --> End([清理完成])
```

**图表来源**
- [backend/app/models/task.py](file://backend/app/models/task.py#L172-L183)

**章节来源**
- [backend/app/models/task.py](file://backend/app/models/task.py#L172-L183)

### 任务与项目状态关联

任务监控与项目状态紧密关联：

```mermaid
erDiagram
PROJECT {
string project_id PK
string name
enum status
datetime created_at
datetime updated_at
string graph_id
string graph_build_task_id
}
TASK {
string task_id PK
string task_type
enum status
datetime created_at
datetime updated_at
int progress
string message
string graph_build_task_id FK
}
PROJECT ||--o{ TASK : contains
```

**图表来源**
- [backend/app/models/project.py](file://backend/app/models/project.py#L27-L98)
- [backend/app/models/task.py](file://backend/app/models/task.py#L22-L51)

**章节来源**
- [backend/app/models/project.py](file://backend/app/models/project.py#L43-L45)

## 依赖关系分析

```mermaid
graph TB
subgraph "API层"
GAPI[graph.py]
RAPI[report.py]
end
subgraph "模型层"
TASK[task.py]
PROJ[project.py]
end
subgraph "服务层"
SERVICE[graph_builder.py]
TEXT[text_processor.py]
end
subgraph "工具层"
RETRY[retry.py]
LOGGER[logger.py]
FILE[file_parser.py]
end
subgraph "配置层"
CONFIG[config.py]
end
GAPI --> TASK
GAPI --> PROJ
GAPI --> SERVICE
GAPI --> RETRY
SERVICE --> TEXT
SERVICE --> CONFIG
TASK --> RETRY
PROJ --> CONFIG
RETRY --> LOGGER
```

**图表来源**
- [backend/app/api/graph.py](file://backend/app/api/graph.py#L1-L25)
- [backend/app/models/task.py](file://backend/app/models/task.py#L1-L12)
- [backend/app/models/project.py](file://backend/app/models/project.py#L1-L14)

**章节来源**
- [backend/app/api/graph.py](file://backend/app/api/graph.py#L1-L25)
- [backend/app/models/task.py](file://backend/app/models/task.py#L1-L12)

## 性能考虑

### 前端轮询策略

前端采用智能轮询机制：
- **轮询间隔**：2秒
- **条件判断**：仅在任务进行中时轮询
- **资源管理**：任务完成后自动停止轮询

### 后端性能优化

- **线程安全**：使用锁机制保证并发安全
- **内存管理**：定期清理已完成任务
- **异步处理**：长任务在后台线程执行

### 错误恢复机制

系统提供多重错误恢复策略：

```mermaid
flowchart TD
Error[任务执行错误] --> CheckRetry{"重试次数<br/>是否达到上限"}
CheckRetry --> |否| Backoff["指数退避延迟<br/>1s, 2s, 4s..."]
Backoff --> Retry["重新执行任务"]
CheckRetry --> |是| MarkFailed["标记任务失败"]
Retry --> Success{"执行成功?"}
Success --> |是| Complete["标记任务完成"]
Success --> |否| CheckRetry
MarkFailed --> Cleanup["清理任务状态"]
Complete --> Cleanup
```

**图表来源**
- [backend/app/utils/retry.py](file://backend/app/utils/retry.py#L15-L77)

**章节来源**
- [backend/app/utils/retry.py](file://backend/app/utils/retry.py#L15-L77)

## 故障排除指南

### 常见问题及解决方案

**问题1：任务状态查询返回404**
- 检查任务ID是否正确
- 确认任务是否已被清理
- 验证任务是否在有效时间内

**问题2：任务长时间处于pending状态**
- 检查系统资源是否充足
- 验证外部服务连接状态
- 查看任务创建时间确认是否超时

**问题3：前端轮询无响应**
- 检查网络连接状态
- 验证API服务器运行状态
- 确认浏览器控制台错误信息

### 调试建议

1. **后端调试**：查看任务管理器中的任务状态
2. **前端调试**：检查轮询逻辑和状态更新
3. **网络调试**：验证API响应时间和错误码

**章节来源**
- [frontend/src/views/Process.vue](file://frontend/src/views/Process.vue#L783-L837)

## 结论

MiroFish的任务监控接口提供了完整、可靠的任务状态跟踪机制。系统采用内存存储确保高性能，同时提供自动清理机制防止资源泄漏。前后端配合的轮询策略保证了实时状态更新，而多重错误恢复机制确保了系统的稳定性。

该接口设计简洁明了，易于集成和扩展，为MiroFish项目提供了强大的任务管理能力。